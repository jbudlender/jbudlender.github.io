<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Working with "large" data in Stata | Joshua Budlender</title> <meta name="author" content="Joshua Budlender"/> <meta name="description" content="Academic website of Joshua Budlender. Labour Economics, Development Economics, Applied Microeconometrics. "/> <meta name="keywords" content="joshua-budlender, josh-budlender, economics, south-africa, saldru, uct"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/jb_favicon.ico"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://www.joshbudlender.co.za/largedatastata/"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="http://www.joshbudlender.co.za/"><span>Joshua</span> Budlender</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Research</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/working/">Working papers</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/publications/">Publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/reports/">Reports</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">other</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/datasets/">Datasets</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/links/">Useful links</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/otherWriting/">Other writing</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/visitSALDRU/">Visit SALDRU</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/aboutwebsite/">About this website</a> </div> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Working with "large" data in Stata</h1> <p class="post-description"></p> </header> <article> <p>The single best resource I’ve found for working with large data in Stata are <a href="https://mcaceresb.github.io/stata-bigdata/index.html" target="_blank" rel="noopener noreferrer">these notes</a> from <a href="https://mcaceresb.github.io/" target="_blank" rel="noopener noreferrer">Mauricio Cáceres Bravo</a>, the creator of <a href="https://gtools.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Gtools</a>.</p> <p>Below are some notes from my own experience at the <a href="https://sa-tied.wider.unu.edu/data" target="_blank" rel="noopener noreferrer">South African National Treasury Secure Data Facility (NT-SDF)</a>:</p> <ul> <li>When using a shared resource (e.g. a server): <ul> <li>Make sure you <code class="language-plaintext highlighter-rouge">clear</code> your dataset when your analysis is finished running, if your dataset is large relative to the amount of memory available on the server. Holding large datasets in memory while not actively using them is a sin!</li> <li>Be considerate if you’re running computationally/memory intensive tasks which use excessive shared resources. Inefficient code in this case is not just a tax on your time, but a tax on all other users’ time too. You may want to consider running the analysis on a subsample of the data, and then running the full analysis over a weekend or night when other users are less affected (see <code class="language-plaintext highlighter-rouge">help sample</code>, note the <code class="language-plaintext highlighter-rouge">by()</code> option).<br> <br> </li> </ul> </li> <li> <p>Use the <a href="https://gtools.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Gtools suite of commands</a> (<code class="language-plaintext highlighter-rouge">help gtools</code>) instead of the native Stata equivalents. These include <code class="language-plaintext highlighter-rouge">gegen</code>, <code class="language-plaintext highlighter-rouge">gcollapse</code>, <code class="language-plaintext highlighter-rouge">gduplicates</code>, <code class="language-plaintext highlighter-rouge">glevelsof</code>, <code class="language-plaintext highlighter-rouge">gunique</code>, <code class="language-plaintext highlighter-rouge">gdistinct</code> and more, which are all essentially (much) faster versions of the original Stata commands and simply replace the original commands in your code. It’s worth checking their website or reading the help file for each command to get maximum benefits (there are often <code class="language-plaintext highlighter-rouge">gtools</code>-specific additions/options you can use), but this is not necessary.</p> </li> <li>If running fixed effects regressions, especially with many fixed effects, use <a href="http://scorreia.com/software/reghdfe/" target="_blank" rel="noopener noreferrer">Sergio Correia’s</a> <code class="language-plaintext highlighter-rouge">reghdfe</code>. To get the computational benefits make sure the fixed effects are specified inside the <code class="language-plaintext highlighter-rouge">absorb()</code> option. In the (very few) cases where <code class="language-plaintext highlighter-rouge">reghdfe</code> is inappropriate, you might want to use <code class="language-plaintext highlighter-rouge">areg</code>. <code class="language-plaintext highlighter-rouge">xtreg, fe</code> is <strong>extremely</strong> slow with many fixed effects and large datasets. <ul> <li>If you need to estimate a large number of fixed effects (or something else) for use in subsequent analysis – save them in a dataset for use later, don’t re-estimate the whole model each time!<br> <br> </li> </ul> </li> <li> <p>For quantiles: <code class="language-plaintext highlighter-rouge">fastxtile</code>, <code class="language-plaintext highlighter-rouge">fasterxtile</code>, <code class="language-plaintext highlighter-rouge">gquantile</code></p> </li> <li>Familiarise yourself with Stata variable <a href="https://povertyaction.github.io/guides/cleaning/variablemanagement/storagetypes/" target="_blank" rel="noopener noreferrer">storage types</a>. You do not want to hold variables in inefficient storage types which take up unnecessary memory, but on the other hand precision issues can also bite in large datasets if you are not careful in how ID variables are created and managed. <ul> <li>Avoid strings as much as possible: they take up a huge amount of memory if you have many observations and/or the strings are long. It is often better to <code class="language-plaintext highlighter-rouge">encode</code> strings and save them as categorical numeric variables with value labels.</li> <li>ID variables can also be converted to numeric variables, saving space and helping with commands like <code class="language-plaintext highlighter-rouge">xtset</code>, but typically not via <code class="language-plaintext highlighter-rouge">encode</code>. In this case use <code class="language-plaintext highlighter-rouge">gegen group</code> (<code class="language-plaintext highlighter-rouge">help gegen</code>). But take care when doing this: for ID variables it is essential that you declare the data type to retain precision. Often a “long” data type is sufficient, e.g. <code class="language-plaintext highlighter-rouge">gegen long firmID = group(stringID)</code> but check digits of accuracy <a href="https://povertyaction.github.io/guides/cleaning/06%20Coding%20in%20Stata/02%20Numerical%20Formats/" target="_blank" rel="noopener noreferrer">here</a>; you may need to declare the type as “double”, at the expense of using more memory again. Note that the numeric ID variable will only be unique within the dataset it is created. Do not use for merging or after appending data.</li> <li>In general it is useful to declare the data type when creating variables if you know what is appropriate. E.g. for a dummy variable: <code class="language-plaintext highlighter-rouge">gen byte female = gender == 2 if !mi(gender)</code>.</li> <li>If you are using dates, using Stata’s native date functions (<code class="language-plaintext highlighter-rouge">help datetime</code>) can offer substantial improvements over using strings or other workarounds.<br> <br> </li> </ul> </li> <li> <p><strong>ALWAYS</strong> <code class="language-plaintext highlighter-rouge">compress</code> your data before saving. This recasts variables into the smallest data type which preserves precision.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">if</code> conditions are slow. If you are repetitively performing analysis on a subset of the data, it is often better to subset the data beforehand with <code class="language-plaintext highlighter-rouge">keep</code> (which can be combined with frames, <code class="language-plaintext highlighter-rouge">preserve</code>/<code class="language-plaintext highlighter-rouge">restore</code>, tempfiles if the subset is only used temporarily). In general you may experience substantial speed improvements by reducing the dataset to what you need for analysis rather than running the analysis on a large dataset with extraneous variables/observations.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">merge</code> can be slow, but a substantial part of this is the internal <code class="language-plaintext highlighter-rouge">sort</code> used to merge. If you consistently sort your data in a particular way before saving, and merge on the same hierarchy of variables, your merges will be quicker. And don’t <code class="language-plaintext highlighter-rouge">sort</code> needlessly!</p> </li> <li> <p>Avoid <code class="language-plaintext highlighter-rouge">gsort</code>, which can be incredibly slow. If you need a descending sort, it is quicker to generate a negative version of the variable you’re sorting on, and sort on that.</p> </li> <li> <p>In general if you have to use a very slow command (e.g <code class="language-plaintext highlighter-rouge">reshape</code>) try to do it once and save the resulting dataset (or just a subset for a <code class="language-plaintext highlighter-rouge">merge</code>) for re-use rather than re-running the time-intensive command again and again every time you need that particular dataset.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">codebook</code> is extremely slow. For numeric variables, a much quicker option to get a sense of a variable is <code class="language-plaintext highlighter-rouge">inspect</code>. If you want the number of unique values of a variable, use <code class="language-plaintext highlighter-rouge">gdistinct</code> or <code class="language-plaintext highlighter-rouge">gunique</code>. <code class="language-plaintext highlighter-rouge">gstats</code> provides a number of useful commands for quick summary statistics (<code class="language-plaintext highlighter-rouge">help gstats</code>).</p> </li> <li> <p>Loading a large dataset takes time. Frames typically provide a speed improvement over <code class="language-plaintext highlighter-rouge">preserve</code>/<code class="language-plaintext highlighter-rouge">restore</code> or using tempfiles.</p> </li> <li> <code class="language-plaintext highlighter-rouge">recode</code> is slow; a more cumbersone <code class="language-plaintext highlighter-rouge">replace if...</code> workflow is usually better in terms of computation time. But your programming time also matters!</li> </ul> </article> </div> </div> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-CE1YR9KWF9"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-CE1YR9KWF9");</script> </body> </html>